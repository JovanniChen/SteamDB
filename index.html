<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ ¸çˆ†æ¨¡æ‹Ÿåœºæ™¯ - å¢å¼ºç‰ˆ</title>
    <style>
      /* ============================================ */
      /* åŸºç¡€æ ·å¼ */
      /* ============================================ */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: linear-gradient(to bottom, #001a33 0%, #000000 100%);
        color: #fff;
        font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        overflow-x: hidden;
        padding: 20px;
      }

      /* ============================================ */
      /* å®¹å™¨å¸ƒå±€ */
      /* ============================================ */
      .container {
        width: 100%;
        max-width: 1400px;
        display: grid;
        grid-template-columns: 300px 1fr 300px;
        gap: 20px;
        margin: 20px auto;
      }

      @media (max-width: 1200px) {
        .container {
          grid-template-columns: 1fr;
        }
      }

      /* ============================================ */
      /* åœºæ™¯å®¹å™¨ */
      /* ============================================ */
      .scene-wrapper {
        grid-column: 1 / -1;
        position: relative;
      }

      #scene {
        position: relative;
        width: 100%;
        height: 70vh;
        min-height: 500px;
        background: linear-gradient(to bottom, #1a3a52 0%, #0a1929 50%, #1a1410 100%);
        border: 2px solid #00ff9d;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 0 30px rgba(0, 255, 157, 0.3);
      }

      /* åœ°å¹³çº¿å’Œåœ°é¢ */
      .horizon {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 30%;
        background: linear-gradient(to top, #2a2520 0%, #1a1410 50%, transparent 100%);
        z-index: 1;
      }

      /* åŸå¸‚å‰ªå½± */
      .cityscape {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 25%;
        z-index: 2;
        opacity: 0.6;
      }

      .building {
        position: absolute;
        bottom: 0;
        background: #0a0a0a;
        border-top: 1px solid #222;
      }

      /* çˆ†ç‚¸ç‚¹æ ‡è®° */
      .ground-zero {
        position: absolute;
        bottom: 25%;
        left: 50%;
        transform: translateX(-50%);
        width: 20px;
        height: 20px;
        z-index: 3;
      }

      .ground-zero::before {
        content: 'âŠ•';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 24px;
        color: #ff3333;
        text-shadow: 0 0 10px rgba(255, 51, 51, 0.8);
      }

      /* ============================================ */
      /* çˆ†ç‚¸æ•ˆæœ */
      /* ============================================ */

      /* åˆå§‹é—ªå…‰ */
      #initial-flash {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at 50% 75%,
          rgba(255, 255, 255, 1) 0%,
          rgba(255, 200, 100, 0.8) 20%,
          transparent 50%);
        opacity: 0;
        z-index: 100;
        pointer-events: none;
      }

      /* å¤šå±‚ç«çƒ */
      .fireball-layer {
        position: absolute;
        bottom: 25%;
        left: 50%;
        transform: translate(-50%, 0);
        border-radius: 50%;
        opacity: 0;
        z-index: 20;
      }

      #fireball-core {
        background: radial-gradient(circle,
          rgba(255, 255, 255, 1) 0%,
          rgba(255, 220, 100, 0.95) 30%,
          rgba(255, 150, 50, 0.8) 60%,
          rgba(255, 80, 0, 0.5) 100%);
        box-shadow: 0 0 100px 50px rgba(255, 200, 0, 0.9),
                    0 0 200px 100px rgba(255, 100, 0, 0.5);
        filter: blur(2px);
      }

      #fireball-outer {
        background: radial-gradient(circle,
          rgba(255, 120, 0, 0.8) 0%,
          rgba(255, 60, 0, 0.6) 50%,
          rgba(150, 30, 0, 0.3) 100%);
        box-shadow: 0 0 150px 75px rgba(255, 80, 0, 0.6);
        filter: blur(5px);
      }

      /* è˜‘è‡äº‘ */
      #mushroom-cloud {
        position: absolute;
        bottom: 25%;
        left: 50%;
        transform: translate(-50%, 0);
        opacity: 0;
        z-index: 15;
      }

      .cloud-stem {
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 0;
        background: linear-gradient(to top,
          rgba(80, 60, 50, 0.9) 0%,
          rgba(100, 80, 70, 0.7) 50%,
          rgba(120, 100, 90, 0.5) 100%);
        box-shadow: 0 0 30px rgba(100, 60, 40, 0.5);
        filter: blur(3px);
      }

      .cloud-cap {
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        background: radial-gradient(ellipse at 50% 100%,
          rgba(100, 80, 70, 0.9) 0%,
          rgba(80, 60, 50, 0.7) 50%,
          rgba(60, 40, 30, 0.4) 100%);
        border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
        box-shadow: 0 0 50px rgba(100, 60, 40, 0.6);
        filter: blur(4px);
      }

      /* å†²å‡»æ³¢ */
      .shockwave {
        position: absolute;
        bottom: 25%;
        left: 50%;
        transform: translate(-50%, 50%);
        border-radius: 50%;
        opacity: 0;
        z-index: 10;
      }

      #shockwave-primary {
        border: 4px solid rgba(255, 200, 100, 0.8);
        box-shadow: 0 0 20px rgba(255, 150, 50, 0.6),
                    inset 0 0 20px rgba(255, 100, 0, 0.3);
      }

      #shockwave-secondary {
        border: 3px solid rgba(200, 200, 200, 0.6);
        box-shadow: 0 0 15px rgba(150, 150, 150, 0.4);
      }

      /* çƒ­è¾å°„æ³¢ */
      #thermal-pulse {
        position: absolute;
        bottom: 25%;
        left: 50%;
        transform: translate(-50%, 50%);
        border-radius: 50%;
        background: radial-gradient(circle,
          rgba(255, 200, 0, 0.3) 0%,
          rgba(255, 100, 0, 0.2) 50%,
          transparent 100%);
        opacity: 0;
        z-index: 9;
      }

      /* è¾å°„è­¦å‘Š */
      #radiation-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        pointer-events: none;
        z-index: 50;
      }

      .radiation-ring {
        position: absolute;
        bottom: 25%;
        left: 50%;
        transform: translate(-50%, 50%);
        border: 2px dashed rgba(0, 255, 0, 0.5);
        border-radius: 50%;
      }

      /* ç²’å­æ•ˆæœå®¹å™¨ */
      #particles {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 30;
        pointer-events: none;
      }

      .particle {
        position: absolute;
        border-radius: 50%;
        opacity: 0;
      }

      /* ============================================ */
      /* æ§åˆ¶é¢æ¿ */
      /* ============================================ */
      .panel {
        background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
        border: 2px solid #00ff9d;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 0 20px rgba(0, 255, 157, 0.2);
      }

      .panel h3 {
        color: #00ff9d;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #00ff9d40;
        font-size: 18px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .control-group {
        margin-bottom: 20px;
      }

      .control-group label {
        display: block;
        color: #00ff9d;
        margin-bottom: 8px;
        font-size: 14px;
        font-weight: 500;
      }

      .control-group input[type="range"] {
        width: 100%;
        height: 6px;
        background: #333;
        border-radius: 3px;
        outline: none;
        -webkit-appearance: none;
      }

      .control-group input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        background: #00ff9d;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 0 10px rgba(0, 255, 157, 0.5);
      }

      .control-group input[type="range"]::-moz-range-thumb {
        width: 18px;
        height: 18px;
        background: #00ff9d;
        border-radius: 50%;
        cursor: pointer;
        border: none;
        box-shadow: 0 0 10px rgba(0, 255, 157, 0.5);
      }

      .value-display {
        color: #fff;
        font-size: 16px;
        font-weight: bold;
        margin-top: 5px;
        text-align: center;
        padding: 5px;
        background: #00000040;
        border-radius: 5px;
      }

      button {
        width: 100%;
        padding: 15px;
        margin: 10px 0;
        background: linear-gradient(135deg, #00ff9d 0%, #00cc7d 100%);
        color: #000;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(0, 255, 157, 0.3);
      }

      button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 255, 157, 0.5);
      }

      button:active:not(:disabled) {
        transform: translateY(0);
      }

      button:disabled {
        background: #333;
        color: #666;
        cursor: not-allowed;
        box-shadow: none;
      }

      button.danger {
        background: linear-gradient(135deg, #ff3333 0%, #cc0000 100%);
        color: #fff;
      }

      button.secondary {
        background: linear-gradient(135deg, #555 0%, #333 100%);
        color: #fff;
      }

      /* ============================================ */
      /* ä¿¡æ¯é¢æ¿ */
      /* ============================================ */
      .info-item {
        display: flex;
        justify-content: space-between;
        padding: 10px;
        margin: 8px 0;
        background: #00000040;
        border-radius: 5px;
        border-left: 3px solid #00ff9d;
      }

      .info-label {
        color: #aaa;
        font-size: 13px;
      }

      .info-value {
        color: #fff;
        font-weight: bold;
        font-size: 14px;
      }

      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
        animation: pulse 2s infinite;
      }

      .status-ready {
        background: #00ff9d;
        box-shadow: 0 0 10px rgba(0, 255, 157, 0.8);
      }

      .status-active {
        background: #ff3333;
        box-shadow: 0 0 10px rgba(255, 51, 51, 0.8);
        animation: pulse-fast 0.5s infinite;
      }

      .status-warning {
        background: #ffaa00;
        box-shadow: 0 0 10px rgba(255, 170, 0, 0.8);
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      @keyframes pulse-fast {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.7; transform: scale(1.2); }
      }

      /* ============================================ */
      /* æ—¶é—´çº¿ */
      /* ============================================ */
      .timeline {
        margin-top: 20px;
      }

      .timeline-item {
        display: flex;
        align-items: center;
        padding: 8px;
        margin: 5px 0;
        background: #00000040;
        border-radius: 5px;
        opacity: 0.5;
        transition: all 0.3s;
      }

      .timeline-item.active {
        opacity: 1;
        background: #00ff9d20;
        border-left: 3px solid #00ff9d;
      }

      .timeline-time {
        min-width: 60px;
        color: #00ff9d;
        font-weight: bold;
        font-size: 12px;
      }

      .timeline-event {
        color: #ccc;
        font-size: 13px;
      }

      /* ============================================ */
      /* ä¼¤å®³åŠå¾„æŒ‡ç¤ºå™¨ */
      /* ============================================ */
      .damage-rings {
        position: absolute;
        bottom: 25%;
        left: 50%;
        transform: translate(-50%, 50%);
        z-index: 5;
        pointer-events: none;
      }

      .damage-ring {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border-radius: 50%;
        border: 2px dashed;
        opacity: 0;
        transition: opacity 0.5s;
      }

      .damage-ring.visible {
        opacity: 0.4;
      }

      .ring-fireball {
        border-color: #ff3333;
      }

      .ring-radiation {
        border-color: #ffaa00;
      }

      .ring-thermal {
        border-color: #ff6600;
      }

      .ring-blast {
        border-color: #ffffff;
      }

      /* ============================================ */
      /* å“åº”å¼è®¾è®¡ */
      /* ============================================ */
      @media (max-width: 768px) {
        .container {
          gap: 10px;
          padding: 10px;
        }

        #scene {
          height: 50vh;
          min-height: 400px;
        }

        .panel {
          padding: 15px;
        }

        button {
          padding: 12px;
          font-size: 14px;
        }
      }

      /* ============================================ */
      /* æç¤ºä¿¡æ¯ */
      /* ============================================ */
      .tooltip {
        position: relative;
        display: inline-block;
        cursor: help;
        color: #00ff9d;
        margin-left: 5px;
      }

      .tooltip:hover::after {
        content: attr(data-tip);
        position: absolute;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        background: #000;
        color: #fff;
        padding: 8px 12px;
        border-radius: 5px;
        font-size: 12px;
        white-space: nowrap;
        z-index: 1000;
        border: 1px solid #00ff9d;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
      <div class="panel">
        <h3>âš™ï¸ å‚æ•°è®¾ç½®</h3>

        <div class="control-group">
          <label>çˆ†ç‚¸å½“é‡ <span class="tooltip" data-tip="TNTå½“é‡ï¼Œå½±å“æ‰€æœ‰æ•ˆæœçš„è§„æ¨¡">â“˜</span></label>
          <input type="range" id="yield-slider" min="1" max="50" value="15" step="1">
          <div class="value-display"><span id="yield-value">15</span> åƒå¨ TNT</div>
        </div>

        <div class="control-group">
          <label>çˆ†ç‚¸é«˜åº¦ <span class="tooltip" data-tip="ç©ºçˆ†é«˜åº¦å½±å“å†²å‡»æ³¢å’Œçƒ­è¾å°„èŒƒå›´">â“˜</span></label>
          <input type="range" id="height-slider" min="0" max="1000" value="500" step="50">
          <div class="value-display"><span id="height-value">500</span> ç±³</div>
        </div>

        <div class="control-group">
          <label>åŠ¨ç”»é€Ÿåº¦</label>
          <input type="range" id="speed-slider" min="0.5" max="3" value="1" step="0.1">
          <div class="value-display"><span id="speed-value">1.0</span>x</div>
        </div>

        <button id="start-button" class="danger">ğŸš€ å¯åŠ¨æ ¸çˆ†</button>
        <button id="reset-button" class="secondary" disabled>ğŸ”„ é‡ç½®åœºæ™¯</button>
        <button id="toggle-rings" class="secondary">ğŸ‘ï¸ æ˜¾ç¤ºä¼¤å®³èŒƒå›´</button>
        <button id="toggle-audio" class="secondary">ğŸ”Š éŸ³æ•ˆ: å·²å¼€å¯</button>
      </div>

      <!-- åœºæ™¯ -->
      <div class="scene-wrapper">
        <div id="scene">
          <div class="horizon"></div>
          <div class="cityscape" id="cityscape"></div>
          <div class="ground-zero"></div>

          <!-- ä¼¤å®³åŠå¾„æŒ‡ç¤ºå™¨ -->
          <div class="damage-rings" id="damage-rings">
            <div class="damage-ring ring-fireball" id="ring-fireball"></div>
            <div class="damage-ring ring-radiation" id="ring-radiation"></div>
            <div class="damage-ring ring-thermal" id="ring-thermal"></div>
            <div class="damage-ring ring-blast" id="ring-blast"></div>
          </div>

          <!-- çˆ†ç‚¸æ•ˆæœ -->
          <div id="initial-flash"></div>
          <div id="thermal-pulse"></div>
          <div class="fireball-layer" id="fireball-outer"></div>
          <div class="fireball-layer" id="fireball-core"></div>

          <div id="mushroom-cloud">
            <div class="cloud-stem"></div>
            <div class="cloud-cap"></div>
          </div>

          <div class="shockwave" id="shockwave-primary"></div>
          <div class="shockwave" id="shockwave-secondary"></div>

          <div id="radiation-overlay">
            <div class="radiation-ring"></div>
          </div>

          <div id="particles"></div>
        </div>
      </div>

      <!-- å³ä¾§ä¿¡æ¯é¢æ¿ -->
      <div class="panel">
        <h3>ğŸ“Š å®æ—¶ä¿¡æ¯</h3>

        <div class="info-item">
          <span class="info-label">ç³»ç»ŸçŠ¶æ€</span>
          <span class="info-value">
            <span class="status-indicator status-ready" id="status-indicator"></span>
            <span id="status-text">å¾…æœº</span>
          </span>
        </div>

        <div class="info-item">
          <span class="info-label">ç«çƒåŠå¾„</span>
          <span class="info-value" id="fireball-radius">è®¡ç®—ä¸­...</span>
        </div>

        <div class="info-item">
          <span class="info-label">çƒ­è¾å°„èŒƒå›´</span>
          <span class="info-value" id="thermal-radius">è®¡ç®—ä¸­...</span>
        </div>

        <div class="info-item">
          <span class="info-label">å†²å‡»æ³¢èŒƒå›´</span>
          <span class="info-value" id="blast-radius">è®¡ç®—ä¸­...</span>
        </div>

        <div class="info-item">
          <span class="info-label">è¾å°„èŒƒå›´</span>
          <span class="info-value" id="radiation-radius">è®¡ç®—ä¸­...</span>
        </div>

        <div class="info-item">
          <span class="info-label">å³°å€¼æ¸©åº¦</span>
          <span class="info-value" id="peak-temp">è®¡ç®—ä¸­...</span>
        </div>

        <div class="timeline">
          <h3 style="margin-top: 20px; font-size: 16px;">â±ï¸ äº‹ä»¶æ—¶é—´çº¿</h3>
          <div class="timeline-item" data-time="0">
            <span class="timeline-time">T+0.0s</span>
            <span class="timeline-event">æ ¸ååº”å¯åŠ¨</span>
          </div>
          <div class="timeline-item" data-time="0.1">
            <span class="timeline-time">T+0.1s</span>
            <span class="timeline-event">åˆå§‹é—ªå…‰</span>
          </div>
          <div class="timeline-item" data-time="0.5">
            <span class="timeline-time">T+0.5s</span>
            <span class="timeline-event">ç«çƒå½¢æˆ</span>
          </div>
          <div class="timeline-item" data-time="1.0">
            <span class="timeline-time">T+1.0s</span>
            <span class="timeline-event">çƒ­è„‰å†²é‡Šæ”¾</span>
          </div>
          <div class="timeline-item" data-time="2.0">
            <span class="timeline-time">T+2.0s</span>
            <span class="timeline-event">å†²å‡»æ³¢æ‰©æ•£</span>
          </div>
          <div class="timeline-item" data-time="5.0">
            <span class="timeline-time">T+5.0s</span>
            <span class="timeline-event">è˜‘è‡äº‘å‡èµ·</span>
          </div>
          <div class="timeline-item" data-time="10.0">
            <span class="timeline-time">T+10s</span>
            <span class="timeline-event">è¾å°„æ‰©æ•£</span>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ============================================
      // å…¨å±€çŠ¶æ€ç®¡ç†
      // ============================================
      const state = {
        isExplosionActive: false,
        isAudioEnabled: true,
        showDamageRings: false,
        yield: 15, // åƒå¨
        height: 500, // ç±³
        speed: 1.0,
        startTime: 0,
        audioContext: null,
        animationFrame: null
      };

      // DOM å…ƒç´ 
      const elements = {
        startButton: document.getElementById('start-button'),
        resetButton: document.getElementById('reset-button'),
        toggleRings: document.getElementById('toggle-rings'),
        toggleAudio: document.getElementById('toggle-audio'),
        yieldSlider: document.getElementById('yield-slider'),
        yieldValue: document.getElementById('yield-value'),
        heightSlider: document.getElementById('height-slider'),
        heightValue: document.getElementById('height-value'),
        speedSlider: document.getElementById('speed-slider'),
        speedValue: document.getElementById('speed-value'),
        statusIndicator: document.getElementById('status-indicator'),
        statusText: document.getElementById('status-text'),
        scene: document.getElementById('scene'),
        cityscape: document.getElementById('cityscape'),
        initialFlash: document.getElementById('initial-flash'),
        fireballCore: document.getElementById('fireball-core'),
        fireballOuter: document.getElementById('fireball-outer'),
        mushroomCloud: document.getElementById('mushroom-cloud'),
        shockwavePrimary: document.getElementById('shockwave-primary'),
        shockwaveSecondary: document.getElementById('shockwave-secondary'),
        thermalPulse: document.getElementById('thermal-pulse'),
        radiationOverlay: document.getElementById('radiation-overlay'),
        particles: document.getElementById('particles'),
        damageRings: document.getElementById('damage-rings')
      };

      // ============================================
      // ç‰©ç†è®¡ç®—å‡½æ•°
      // ============================================
      function calculateEffects(yieldKt, heightM) {
        // åŸºäºå®é™…æ ¸æ­¦å™¨ç‰©ç†çš„ç®€åŒ–è®¡ç®—
        const fireballRadius = Math.pow(yieldKt, 0.4) * 50; // ç±³
        const thermalRadius = Math.pow(yieldKt, 0.41) * 500; // ä¸‰åº¦çƒ§ä¼¤èŒƒå›´
        const blastRadius5psi = Math.pow(yieldKt, 0.33) * 1000; // 5 PSI å†²å‡»æ³¢
        const radiationRadius = Math.pow(yieldKt, 0.19) * 1500; // 500 rem è¾å°„
        const peakTemp = 100000000 * Math.pow(yieldKt / 15, 0.5); // ç«çƒå³°å€¼æ¸©åº¦ï¼ˆKï¼‰

        return {
          fireballRadius: Math.round(fireballRadius),
          thermalRadius: Math.round(thermalRadius),
          blastRadius: Math.round(blastRadius5psi),
          radiationRadius: Math.round(radiationRadius),
          peakTemp: peakTemp.toExponential(2)
        };
      }

      function updateCalculations() {
        const effects = calculateEffects(state.yield, state.height);

        document.getElementById('fireball-radius').textContent = `${effects.fireballRadius} ç±³`;
        document.getElementById('thermal-radius').textContent = `${effects.thermalRadius} ç±³`;
        document.getElementById('blast-radius').textContent = `${effects.blastRadius} ç±³`;
        document.getElementById('radiation-radius').textContent = `${effects.radiationRadius} ç±³`;
        document.getElementById('peak-temp').textContent = `${effects.peakTemp} K`;

        // æ›´æ–°ä¼¤å®³åŠå¾„åœ†åœˆå¤§å°ï¼ˆè½¬æ¢ä¸ºåƒç´ ï¼Œç®€åŒ–æ¯”ä¾‹ï¼‰
        const scale = 0.15; // åƒç´ /ç±³ æ¯”ä¾‹å› å­
        document.getElementById('ring-fireball').style.width =
          document.getElementById('ring-fireball').style.height = `${effects.fireballRadius * scale}px`;
        document.getElementById('ring-thermal').style.width =
          document.getElementById('ring-thermal').style.height = `${effects.thermalRadius * scale}px`;
        document.getElementById('ring-blast').style.width =
          document.getElementById('ring-blast').style.height = `${effects.blastRadius * scale}px`;
        document.getElementById('ring-radiation').style.width =
          document.getElementById('ring-radiation').style.height = `${effects.radiationRadius * scale}px`;
      }

      // ============================================
      // éŸ³æ•ˆç”Ÿæˆ (Web Audio API)
      // ============================================
      function initAudio() {
        if (!state.audioContext) {
          state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
      }

      function playExplosionSound() {
        if (!state.isAudioEnabled) return;
        initAudio();

        const ctx = state.audioContext;
        const now = ctx.currentTime;

        // çˆ†ç‚¸ä½é¢‘éš†éš†å£°
        const osc1 = ctx.createOscillator();
        const gain1 = ctx.createGain();
        osc1.connect(gain1);
        gain1.connect(ctx.destination);

        osc1.type = 'sawtooth';
        osc1.frequency.setValueAtTime(50, now);
        osc1.frequency.exponentialRampToValueAtTime(20, now + 2);

        gain1.gain.setValueAtTime(0.3, now);
        gain1.gain.exponentialRampToValueAtTime(0.01, now + 3);

        osc1.start(now);
        osc1.stop(now + 3);

        // åˆå§‹çˆ†ç‚¸å™ªéŸ³
        const bufferSize = ctx.sampleRate * 0.5;
        const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < bufferSize; i++) {
          data[i] = (Math.random() * 2 - 1) * Math.exp(-i / bufferSize * 5);
        }

        const noise = ctx.createBufferSource();
        const gainNoise = ctx.createGain();
        noise.buffer = buffer;
        noise.connect(gainNoise);
        gainNoise.connect(ctx.destination);
        gainNoise.gain.setValueAtTime(0.2, now);
        noise.start(now);
      }

      function playCrackleSound(delay) {
        if (!state.isAudioEnabled) return;
        initAudio();

        const ctx = state.audioContext;
        const now = ctx.currentTime + delay;

        // çˆ†è£‚å£°
        for (let i = 0; i < 5; i++) {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);

          osc.type = 'square';
          const freq = 200 + Math.random() * 400;
          osc.frequency.setValueAtTime(freq, now + i * 0.1);

          gain.gain.setValueAtTime(0.1, now + i * 0.1);
          gain.gain.exponentialRampToValueAtTime(0.01, now + i * 0.1 + 0.05);

          osc.start(now + i * 0.1);
          osc.stop(now + i * 0.1 + 0.05);
        }
      }

      // ============================================
      // åŸå¸‚å‰ªå½±ç”Ÿæˆ
      // ============================================
      function generateCityscape() {
        elements.cityscape.innerHTML = '';
        const buildingCount = 30;
        const sceneWidth = elements.scene.offsetWidth;

        for (let i = 0; i < buildingCount; i++) {
          const building = document.createElement('div');
          building.className = 'building';

          const width = 20 + Math.random() * 60;
          const height = 30 + Math.random() * 120;
          const left = (i / buildingCount) * sceneWidth + (Math.random() - 0.5) * 20;

          building.style.width = `${width}px`;
          building.style.height = `${height}px`;
          building.style.left = `${left}px`;

          elements.cityscape.appendChild(building);
        }
      }

      // ============================================
      // ç²’å­ç³»ç»Ÿ
      // ============================================
      function createParticles(count, delay) {
        setTimeout(() => {
          for (let i = 0; i < count; i++) {
            setTimeout(() => {
              const particle = document.createElement('div');
              particle.className = 'particle';

              const size = 2 + Math.random() * 6;
              const angle = Math.random() * Math.PI * 2;
              const distance = 50 + Math.random() * 300;
              const duration = 2 + Math.random() * 3;

              particle.style.width = particle.style.height = `${size}px`;
              particle.style.background = `rgba(255, ${100 + Math.random() * 155}, 0, 0.8)`;
              particle.style.bottom = '25%';
              particle.style.left = '50%';
              particle.style.filter = `blur(${Math.random() * 2}px)`;

              elements.particles.appendChild(particle);

              // åŠ¨ç”»
              particle.animate([
                {
                  transform: 'translate(-50%, 0) scale(1)',
                  opacity: 0
                },
                {
                  transform: `translate(calc(-50% + ${Math.cos(angle) * distance}px), ${-Math.sin(angle) * distance}px) scale(0.5)`,
                  opacity: 1,
                  offset: 0.3
                },
                {
                  transform: `translate(calc(-50% + ${Math.cos(angle) * distance * 2}px), ${-Math.sin(angle) * distance * 2}px) scale(0.2)`,
                  opacity: 0
                }
              ], {
                duration: duration * 1000 / state.speed,
                easing: 'ease-out'
              });

              setTimeout(() => particle.remove(), duration * 1000 / state.speed);
            }, i * 20 / state.speed);
          }
        }, delay / state.speed);
      }

      // ============================================
      // æ—¶é—´çº¿æ›´æ–°
      // ============================================
      function updateTimeline(currentTime) {
        const timelineItems = document.querySelectorAll('.timeline-item');
        timelineItems.forEach(item => {
          const time = parseFloat(item.dataset.time);
          if (currentTime >= time) {
            item.classList.add('active');
          } else {
            item.classList.remove('active');
          }
        });
      }

      // ============================================
      // æ ¸å¿ƒçˆ†ç‚¸åŠ¨ç”»
      // ============================================
      function startNuclearDetonation() {
        if (state.isExplosionActive) return;
        state.isExplosionActive = true;
        state.startTime = Date.now();

        // æ›´æ–°UIçŠ¶æ€
        elements.startButton.disabled = true;
        elements.resetButton.disabled = true;
        elements.statusIndicator.className = 'status-indicator status-active';
        elements.statusText.textContent = 'çˆ†ç‚¸è¿›è¡Œä¸­';

        // æ’­æ”¾éŸ³æ•ˆ
        playExplosionSound();

        const s = 1000 / state.speed; // é€Ÿåº¦è°ƒæ•´å› å­
        const scale = Math.pow(state.yield / 15, 0.4); // è§„æ¨¡å› å­

        // åŠ¨ç”»æ—¶é—´çº¿
        const timeline = [
          // T+0: åˆå§‹é—ªå…‰
          {
            time: 50,
            action: () => {
              elements.initialFlash.animate([
                { opacity: 0 },
                { opacity: 1, offset: 0.1 },
                { opacity: 0.8, offset: 0.3 },
                { opacity: 0 }
              ], {
                duration: 500 / state.speed,
                easing: 'ease-out'
              });
            }
          },

          // T+0.1s: ç«çƒæ ¸å¿ƒ
          {
            time: 100,
            action: () => {
              const coreSize = 100 * scale;
              elements.fireballCore.animate([
                {
                  width: '0px',
                  height: '0px',
                  opacity: 0,
                  transform: 'translate(-50%, 0)'
                },
                {
                  width: `${coreSize}px`,
                  height: `${coreSize}px`,
                  opacity: 1,
                  transform: 'translate(-50%, -20%)',
                  offset: 0.3
                },
                {
                  width: `${coreSize * 1.5}px`,
                  height: `${coreSize * 1.5}px`,
                  opacity: 0.9,
                  transform: 'translate(-50%, -30%)'
                }
              ], {
                duration: 1000 / state.speed,
                fill: 'forwards',
                easing: 'cubic-bezier(0.1, 0.9, 0.3, 1)'
              });

              // ç«çƒå¤–å±‚
              setTimeout(() => {
                const outerSize = 150 * scale;
                elements.fireballOuter.animate([
                  {
                    width: '0px',
                    height: '0px',
                    opacity: 0
                  },
                  {
                    width: `${outerSize}px`,
                    height: `${outerSize}px`,
                    opacity: 0.8,
                    offset: 0.5
                  },
                  {
                    width: `${outerSize * 1.8}px`,
                    height: `${outerSize * 1.8}px`,
                    opacity: 0.3
                  }
                ], {
                  duration: 2000 / state.speed,
                  fill: 'forwards',
                  easing: 'ease-out'
                });
              }, 200 / state.speed);
            }
          },

          // T+0.5s: çƒ­è„‰å†²
          {
            time: 500,
            action: () => {
              const thermalSize = 400 * scale;
              elements.thermalPulse.animate([
                {
                  width: '0px',
                  height: '0px',
                  opacity: 0.6
                },
                {
                  width: `${thermalSize}px`,
                  height: `${thermalSize}px`,
                  opacity: 0
                }
              ], {
                duration: 1500 / state.speed,
                easing: 'ease-out'
              });

              playCrackleSound(0);
            }
          },

          // T+1s: å†²å‡»æ³¢
          {
            time: 1000,
            action: () => {
              const shockSize = 800 * scale;
              elements.shockwavePrimary.animate([
                {
                  width: '0px',
                  height: '0px',
                  opacity: 1
                },
                {
                  width: `${shockSize}px`,
                  height: `${shockSize}px`,
                  opacity: 0
                }
              ], {
                duration: 2000 / state.speed,
                easing: 'ease-out'
              });

              setTimeout(() => {
                elements.shockwaveSecondary.animate([
                  {
                    width: '0px',
                    height: '0px',
                    opacity: 0.7
                  },
                  {
                    width: `${shockSize * 1.3}px`,
                    height: `${shockSize * 1.3}px`,
                    opacity: 0
                  }
                ], {
                  duration: 3000 / state.speed,
                  easing: 'ease-out'
                });
              }, 500 / state.speed);
            }
          },

          // T+1.5s: ç²’å­é£æº…
          {
            time: 1500,
            action: () => {
              createParticles(50, 0);
            }
          },

          // T+2s: è˜‘è‡äº‘å¼€å§‹å½¢æˆ
          {
            time: 2000,
            action: () => {
              const cloudWidth = 250 * scale;
              const cloudHeight = 300 * scale;
              const stemHeight = 200 * scale;

              // äº‘æŸ±
              const stem = elements.mushroomCloud.querySelector('.cloud-stem');
              stem.animate([
                { height: '0px', opacity: 0 },
                { height: `${stemHeight}px`, opacity: 0.8 }
              ], {
                duration: 3000 / state.speed,
                fill: 'forwards',
                easing: 'ease-in'
              });

              // äº‘å¸½
              setTimeout(() => {
                const cap = elements.mushroomCloud.querySelector('.cloud-cap');
                cap.animate([
                  {
                    width: '0px',
                    height: '0px',
                    opacity: 0,
                    bottom: `${stemHeight * 0.5}px`
                  },
                  {
                    width: `${cloudWidth}px`,
                    height: `${cloudHeight * 0.7}px`,
                    opacity: 0.7,
                    bottom: `${stemHeight * 0.8}px`,
                    offset: 0.5
                  },
                  {
                    width: `${cloudWidth * 1.3}px`,
                    height: `${cloudHeight}px`,
                    opacity: 0.8,
                    bottom: `${stemHeight}px`
                  }
                ], {
                  duration: 8000 / state.speed,
                  fill: 'forwards',
                  easing: 'ease-out'
                });
              }, 1000 / state.speed);

              // è˜‘è‡äº‘å®¹å™¨å¯è§
              elements.mushroomCloud.animate([
                { opacity: 0 },
                { opacity: 1 }
              ], {
                duration: 500 / state.speed,
                fill: 'forwards'
              });
            }
          },

          // T+5s: ç«çƒæ¶ˆé€€
          {
            time: 5000,
            action: () => {
              elements.fireballCore.animate([
                { opacity: 0.9 },
                { opacity: 0 }
              ], {
                duration: 3000 / state.speed,
                fill: 'forwards',
                easing: 'ease-in'
              });

              elements.fireballOuter.animate([
                { opacity: 0.3 },
                { opacity: 0 }
              ], {
                duration: 4000 / state.speed,
                fill: 'forwards',
                easing: 'ease-in'
              });
            }
          },

          // T+8s: è¾å°„è­¦å‘Š
          {
            time: 8000,
            action: () => {
              elements.radiationOverlay.animate([
                { opacity: 0 },
                { opacity: 0.1, offset: 0.5 },
                { opacity: 0 }
              ], {
                duration: 500 / state.speed,
                iterations: Infinity
              });

              elements.statusIndicator.className = 'status-indicator status-warning';
            }
          },

          // T+15s: ç¨³å®šçŠ¶æ€
          {
            time: 15000,
            action: () => {
              elements.statusText.textContent = 'è¾å°„æŒç»­ä¸­';
              elements.resetButton.disabled = false;
            }
          }
        ];

        // æ‰§è¡Œæ—¶é—´çº¿
        timeline.forEach(event => {
          setTimeout(() => {
            event.action();
          }, event.time / state.speed);
        });

        // å®æ—¶æ›´æ–°æ—¶é—´çº¿æ˜¾ç¤º
        const startTime = Date.now();
        const updateInterval = setInterval(() => {
          if (!state.isExplosionActive) {
            clearInterval(updateInterval);
            return;
          }
          const elapsed = (Date.now() - startTime) / 1000 * state.speed;
          updateTimeline(elapsed);
        }, 50);
      }

      // ============================================
      // é‡ç½®åœºæ™¯
      // ============================================
      function resetScene() {
        state.isExplosionActive = false;

        // åœæ­¢æ‰€æœ‰åŠ¨ç”»
        [elements.initialFlash, elements.fireballCore, elements.fireballOuter,
         elements.mushroomCloud, elements.shockwavePrimary, elements.shockwaveSecondary,
         elements.thermalPulse, elements.radiationOverlay].forEach(el => {
          el.getAnimations().forEach(anim => anim.cancel());
          el.style.opacity = '0';
          el.style.width = '0';
          el.style.height = '0';
        });

        // æ¸…é™¤ç²’å­
        elements.particles.innerHTML = '';

        // é‡ç½®çŠ¶æ€
        elements.statusIndicator.className = 'status-indicator status-ready';
        elements.statusText.textContent = 'å¾…æœº';
        elements.startButton.disabled = false;
        elements.resetButton.disabled = true;

        // é‡ç½®æ—¶é—´çº¿
        document.querySelectorAll('.timeline-item').forEach(item => {
          item.classList.remove('active');
        });

        // é‡æ–°ç”ŸæˆåŸå¸‚
        generateCityscape();
      }

      // ============================================
      // æ§åˆ¶å™¨äº‹ä»¶
      // ============================================

      // å‚æ•°æ»‘å—
      elements.yieldSlider.addEventListener('input', (e) => {
        state.yield = parseFloat(e.target.value);
        elements.yieldValue.textContent = state.yield;
        updateCalculations();
      });

      elements.heightSlider.addEventListener('input', (e) => {
        state.height = parseFloat(e.target.value);
        elements.heightValue.textContent = state.height;
        updateCalculations();
      });

      elements.speedSlider.addEventListener('input', (e) => {
        state.speed = parseFloat(e.target.value);
        elements.speedValue.textContent = state.speed.toFixed(1);
      });

      // æŒ‰é’®
      elements.startButton.addEventListener('click', startNuclearDetonation);
      elements.resetButton.addEventListener('click', resetScene);

      elements.toggleRings.addEventListener('click', () => {
        state.showDamageRings = !state.showDamageRings;
        const rings = elements.damageRings.querySelectorAll('.damage-ring');
        rings.forEach(ring => {
          ring.classList.toggle('visible', state.showDamageRings);
        });
        elements.toggleRings.textContent = state.showDamageRings ?
          'ğŸ‘ï¸ éšè—ä¼¤å®³èŒƒå›´' : 'ğŸ‘ï¸ æ˜¾ç¤ºä¼¤å®³èŒƒå›´';
      });

      elements.toggleAudio.addEventListener('click', () => {
        state.isAudioEnabled = !state.isAudioEnabled;
        elements.toggleAudio.textContent = state.isAudioEnabled ?
          'ğŸ”Š éŸ³æ•ˆ: å·²å¼€å¯' : 'ğŸ”‡ éŸ³æ•ˆ: å·²å…³é—­';
      });

      // ============================================
      // åˆå§‹åŒ–
      // ============================================
      function init() {
        generateCityscape();
        updateCalculations();

        // å“åº”å¼è°ƒæ•´
        window.addEventListener('resize', () => {
          if (!state.isExplosionActive) {
            generateCityscape();
          }
        });

        console.log('%cæ ¸çˆ†æ¨¡æ‹Ÿå™¨ v2.0', 'color: #00ff9d; font-size: 20px; font-weight: bold;');
        console.log('%cä»…ä¾›æ•™è‚²å’Œç§‘å­¦ç ”ç©¶ä½¿ç”¨', 'color: #ffaa00; font-size: 14px;');
      }

      // å¯åŠ¨
      init();
    </script>
  </body>
</html>
